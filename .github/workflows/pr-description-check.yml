name: PR description check

on:
  pull_request:
    types: [opened, edited, reopened, synchronize, ready_for_review]
    branches:
      - master
      - ep2pl

permissions:
  contents: read
  pull-requests: read

jobs:
  validate-pr-body:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR description sections
        uses: actions/github-script@v7
        with:
          script: |
            const body = (context.payload.pull_request.body || "").replace(/\r\n/g, "\n");

            const requiredHeadings = [
              "## Opis zmian",
              "## Powod zmiany",
              "## Jak testowano",
              "## Lista kontrolna",
            ];

            const errors = [];

            for (const heading of requiredHeadings) {
              if (!body.includes(heading)) {
                errors.push(`Brakuje sekcji: "${heading}".`);
              }
            }

            function section(title) {
              const escaped = title.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
              const re = new RegExp(`${escaped}\\n([\\s\\S]*?)(?=\\n## |$)`, "m");
              const m = body.match(re);
              return m ? m[1].trim() : "";
            }

            function normalizedText(s) {
              return s
                .replace(/<!--[\s\S]*?-->/g, "")
                .split("\n")
                .map((line) => line.trim())
                .filter((line) => line && line !== "-" && line !== "*")
                .join(" ")
                .trim();
            }

            const opis = normalizedText(section("## Opis zmian"));
            const powod = normalizedText(section("## Powod zmiany"));

            if (opis.length < 20 || /<uzupelnij>|TODO|TBD/i.test(opis)) {
              errors.push('Sekcja "## Opis zmian" jest pusta lub zawiera placeholder.');
            }

            if (powod.length < 20 || /<uzupelnij>|TODO|TBD/i.test(powod)) {
              errors.push('Sekcja "## Powod zmiany" jest pusta lub zawiera placeholder.');
            }

            const testSection = section("## Jak testowano");
            const checkedTests = (testSection.match(/- \[x\]/gi) || []).length;
            if (checkedTests < 2) {
              errors.push('W sekcji "## Jak testowano" zaznacz co najmniej 2 wykonane pozycje.');
            }

            const checklist = section("## Lista kontrolna");
            const hasConfirmation = /- \[x\].*Potwierdzam, ze uzupelnilem wszystkie sekcje/i.test(checklist);
            if (!hasConfirmation) {
              errors.push('W sekcji "## Lista kontrolna" zaznacz pozycje potwierdzenia wypelnienia opisu.');
            }

            const usageChecked = /- \[x\].*Jesli dodano funkcje, dodano tez krotki opis uzycia/i.test(checklist);
            const notApplicableChecked = /- \[x\].*Nie dotyczy \(ta zmiana nie dodaje nowych funkcji\)/i.test(checklist);
            if (!usageChecked && !notApplicableChecked) {
              errors.push('W "## Lista kontrolna" zaznacz opis uzycia albo "Nie dotyczy".');
            }

            if (errors.length) {
              core.setFailed(`Niepoprawny opis PR:\n- ${errors.join("\n- ")}`);
            } else {
              core.info("Opis PR spelnia wymagania.");
            }
